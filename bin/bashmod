#!/usr/bin/env bash
# Bash wrapper for bashmod TUI
# This provides a simple command that works whether bashmod is installed via pipx or run from source

set -e

# Get the script's location to find the project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# If we're in a project directory with source code, always use local venv
if [ -f "$PROJECT_ROOT/bashmod/__main__.py" ]; then
    # Create venv if it doesn't exist
    if [ ! -d "$PROJECT_ROOT/venv" ]; then
        echo "Initializing..." >&2
        python3 -m venv --copies "$PROJECT_ROOT/venv"
    fi

    # Activate venv if not already in one
    if [ -z "$VIRTUAL_ENV" ]; then
        source "$PROJECT_ROOT/venv/bin/activate"
    fi

    # Check if dependencies are installed by trying to import textual
    if ! python -c "import textual" &> /dev/null; then
        echo "Tackling first time setup..." >&2
        pip install -q -e "$PROJECT_ROOT"
    fi

    exec python -m bashmod "$@"
fi

# Otherwise, try to run globally installed bashmod
if command -v bashmod &> /dev/null; then
    exec bashmod "$@"
fi

# If we get here, bashmod is not installed and not in dev mode
echo "Error: bashmod is not installed and cannot be run from source" >&2
echo "" >&2
echo "To install with pipx:" >&2
echo "  pipx install git+https://github.com/user/bashmod.git" >&2
echo "" >&2
echo "Or run from this directory to auto-setup dev environment" >&2
exit 1
