#!/usr/bin/env bash
# Bash wrapper for bash-mods TUI
# This provides a simple command that works whether bash-mods is installed via pipx or run from source

set -e

# Try to run bash-mods if it's installed
if command -v bash-mods &> /dev/null; then
    exec bash-mods "$@"
fi

# Otherwise, try to run from source (development mode)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

if [ -f "$PROJECT_ROOT/bash_mods/__main__.py" ]; then
    # Create venv if it doesn't exist
    if [ ! -d "$PROJECT_ROOT/venv" ]; then
        echo "Initializing..." >&2
        python3 -m venv --copies "$PROJECT_ROOT/venv"
    fi

    # Activate venv if not already in one
    if [ -z "$VIRTUAL_ENV" ]; then
        source "$PROJECT_ROOT/venv/bin/activate"
    fi

    # Check if dependencies are installed by trying to import textual
    if ! python -c "import textual" &> /dev/null; then
        echo "Tackling first time setup..." >&2
        pip install -q -e "$PROJECT_ROOT"
    fi

    exec python -m bash_mods "$@"
fi

# If we get here, bash-mods is not installed and not in dev mode
echo "Error: bash-mods is not installed and cannot be run from source" >&2
echo "" >&2
echo "To install with pipx:" >&2
echo "  pipx install git+https://github.com/user/bash-mods.git" >&2
echo "" >&2
echo "Or run from this directory to auto-setup dev environment" >&2
exit 1
